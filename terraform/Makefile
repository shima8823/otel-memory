.PHONY: set-project-id ssh grafana pprof sync

# --- terraform ---
re:
	terraform destroy -auto-approve && terraform apply -auto-approve

# --- è¨­å®š ---
ZONE = asia-northeast1-a
INSTANCE_NAME = otel-collector
GIT_BRANCH = $(shell git rev-parse --abbrev-ref HEAD)

set-project-id:
	@if [ -z "$(PROJECT_ID)" ]; then \
		echo "PROJECT_ID is not set. Please run the following command to set it:"; \
		echo "export PROJECT_ID=\$$(gcloud config get-value project)"; \
		exit 1; \
	fi

# Terraformå®Ÿè¡Œæ™‚ã«ãƒ–ãƒ©ãƒ³ãƒåã‚’æ¸¡ã™
tf-apply: set-project-id
	terraform apply -var="project_id=$(PROJECT_ID)" -var="git_branch=$(GIT_BRANCH)" -auto-approve

re: set-project-id
	terraform destroy -var="project_id=$(PROJECT_ID)" -auto-approve && \
	terraform apply -var="project_id=$(PROJECT_ID)" -var="git_branch=$(GIT_BRANCH)" -auto-approve

ssh: set-project-id
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE)

grafana: set-project-id
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- -NL 3000:localhost:3000

pprof: set-project-id
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- -NL 1777:localhost:1777

# --- é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒãƒ³ãƒ‰ ---

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ VM ã«åŒæœŸï¼ˆGitã®çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšã€æ‰‹å…ƒã®æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åæ˜ ï¼‰
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ VM ã«åŒæœŸ
sync: set-project-id
	@echo "ğŸš€ Syncing local project to VM..."
	@rm -f project.tar.gz
	# ä»¥å‰ã®æ›¸ãæ–¹ã ã¨ --exclude ãŒã†ã¾ãå‹•ã‹ãªã‹ã£ãŸã®ã§ä¿®æ­£
	tar -czf project.tar.gz \
		--exclude='.git' \
		--exclude='.terraform' \
		--exclude='*.tfstate*' \
		-C .. .
	gcloud compute scp project.tar.gz $(INSTANCE_NAME):~/project.tar.gz --project $(PROJECT_ID) --zone $(ZONE)
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- \
		"sudo mkdir -p /home/ubuntu/otel-memory && \
		 sudo tar -xzf ~/project.tar.gz -C /home/ubuntu/otel-memory && \
		 sudo chown -R ubuntu:ubuntu /home/ubuntu/otel-memory && \
		 rm ~/project.tar.gz"
	@rm project.tar.gz
	@echo "âœ… Sync completed!"

# ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ï¼ˆè¨­å®šå¤‰æ›´ã‚„ãƒãƒ¼ãƒˆã®è¿½åŠ ã‚’åæ˜ ï¼‰
restart: set-project-id
	@echo "ğŸ”„ Recreating containers to apply changes..."
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- \
		"cd /home/ubuntu/otel-memory && sudo docker-compose up -d --force-recreate"
	@echo "âœ… All services are up-to-date and running!"

# --- loadgen instance ---
# æ¥ç¶š
loadgen-ssh: set-project-id
	gcloud compute ssh otel-loadgen --project $(PROJECT_ID) --zone $(ZONE)

# è² è·è©¦é¨“ã®å®Ÿè¡Œ
# ä¾‹: make loadgen SCENARIO=spike DURATION=180s
SCENARIO ?= sustained
DURATION ?= 60s
loadgen: set-project-id
	gcloud compute ssh otel-loadgen --project $(PROJECT_ID) --zone $(ZONE) -- \
		"cd ~/otel-memory/loadgen && ./loadgen -endpoint \$$COLLECTOR_ENDPOINT -scenario $(SCENARIO) -duration $(DURATION)"

	