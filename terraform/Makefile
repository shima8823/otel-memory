# ç¾åœ¨ã®ãƒ•ãƒ­ãƒ¼
# make re
# make sync
# make restart
# make scenario-1
# make grafana
# make pprof
# cd ../ && make pprof-heap

.PHONY: set-project-id ssh grafana pprof forward forward-bg forward-stop forward-status sync restart loadgen-ssh loadgen scenario-1

# --- terraform ---

# --- è¨­å®š ---
ZONE = asia-northeast1-a
INSTANCE_NAME = otel-collector
GIT_BRANCH = $(shell git rev-parse --abbrev-ref HEAD)
TAR_PATH ?= /tmp/otel-memory-project.tar.gz

set-project-id:
	@if [ -z "$(PROJECT_ID)" ]; then \
		echo "PROJECT_ID is not set. Please run the following command to set it:"; \
		echo "export PROJECT_ID=\$$(gcloud config get-value project)"; \
		exit 1; \
	fi

# Terraformå®Ÿè¡Œæ™‚ã«ãƒ–ãƒ©ãƒ³ãƒåã‚’æ¸¡ã™
# ä½¿ç”¨ä¾‹: make re (å†æ§‹ç¯‰) ã¾ãŸã¯ make tf-apply (é©ç”¨)
tf-apply: set-project-id
	terraform apply -var="project_id=$(PROJECT_ID)" -var="git_branch=$(GIT_BRANCH)" -auto-approve
destroy: set-project-id
	terraform destroy -var="project_id=$(PROJECT_ID)" -auto-approve

re: set-project-id
	terraform destroy -var="project_id=$(PROJECT_ID)" -auto-approve && \
	terraform apply -var="project_id=$(PROJECT_ID)" -var="git_branch=$(GIT_BRANCH)" -auto-approve

ssh: set-project-id
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE)

grafana: set-project-id
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- -NL 3000:localhost:3000

pprof: set-project-id
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- -NL 1777:localhost:1777

# Grafana / Prometheus / Jaeger / pprof ã‚’ã¾ã¨ã‚ã¦ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰
forward: set-project-id
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- \
		-NL 3000:localhost:3000 \
		-NL 9090:localhost:9090 \
		-NL 16686:localhost:16686 \
		-NL 1777:localhost:1777

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã¾ã¨ã‚ã¦ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰
FORWARD_PID_FILE ?= ../.forward.pid
FORWARD_LOG_FILE ?= ../notes/pprof-logs/port_forward.log

forward-bg: set-project-id
	@mkdir -p ../notes/pprof-logs
	@if [ -f "$(FORWARD_PID_FILE)" ] && kill -0 "$$(cat $(FORWARD_PID_FILE))" 2>/dev/null; then \
		echo "âœ… Port-forward already running (pid=$$(cat $(FORWARD_PID_FILE)))"; \
		exit 0; \
	fi
	@nohup gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- \
		-NL 3000:localhost:3000 \
		-NL 9090:localhost:9090 \
		-NL 16686:localhost:16686 \
		-NL 1777:localhost:1777 \
		> "$(FORWARD_LOG_FILE)" 2>&1 & echo $$! > "$(FORWARD_PID_FILE)"
	@echo "âœ… Port-forward started (pid=$$(cat $(FORWARD_PID_FILE)))"

forward-stop:
	@if [ ! -f "$(FORWARD_PID_FILE)" ]; then \
		echo "â„¹ï¸  Port-forward not running (no pid file)"; \
		exit 0; \
	fi
	@PID=$$(cat "$(FORWARD_PID_FILE)"); \
	if kill -0 $$PID 2>/dev/null; then \
		kill $$PID; \
		for i in 1 2 3 4 5; do \
			kill -0 $$PID 2>/dev/null || break; \
			sleep 1; \
		done; \
		if kill -0 $$PID 2>/dev/null; then \
			kill -9 $$PID 2>/dev/null || true; \
			sleep 1; \
		fi; \
		if kill -0 $$PID 2>/dev/null; then \
			echo "âŒ Port-forward still running (pid=$$PID)"; \
			exit 1; \
		fi; \
		echo "âœ… Port-forward stopped (pid=$$PID)"; \
	else \
		echo "â„¹ï¸  Port-forward pid not running (pid=$$PID)"; \
	fi
	@rm -f "$(FORWARD_PID_FILE)"

forward-status:
	@if [ -f "$(FORWARD_PID_FILE)" ] && kill -0 "$$(cat $(FORWARD_PID_FILE))" 2>/dev/null; then \
		echo "âœ… Port-forward running (pid=$$(cat $(FORWARD_PID_FILE)))"; \
	else \
		echo "â„¹ï¸  Port-forward not running"; \
	fi

# --- é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒãƒ³ãƒ‰ ---

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ VM ã«åŒæœŸï¼ˆGitã®çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšã€æ‰‹å…ƒã®æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åæ˜ ï¼‰
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ VM ã«åŒæœŸ
sync: set-project-id
	@echo "ğŸš€ Syncing local project to VM..."
	@rm -f "$(TAR_PATH)"
	# ä»¥å‰ã®æ›¸ãæ–¹ã ã¨ --exclude ãŒã†ã¾ãå‹•ã‹ãªã‹ã£ãŸã®ã§ä¿®æ­£
	tar -czf "$(TAR_PATH)" \
		--exclude='.git' \
		--exclude='.terraform' \
		--exclude='*.tfstate*' \
		-C .. .
	gcloud compute scp "$(TAR_PATH)" $(INSTANCE_NAME):~/project.tar.gz --project $(PROJECT_ID) --zone $(ZONE)
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- \
		"sudo mkdir -p /home/ubuntu/otel-memory && \
		 sudo tar -xzf ~/project.tar.gz -C /home/ubuntu/otel-memory && \
		 sudo chown -R ubuntu:ubuntu /home/ubuntu/otel-memory && \
		 rm ~/project.tar.gz"
	@rm -f "$(TAR_PATH)" project.tar.gz
	@echo "âœ… Sync completed!"

# ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ï¼ˆè¨­å®šå¤‰æ›´ã‚„ãƒãƒ¼ãƒˆã®è¿½åŠ ã‚’åæ˜ ï¼‰
restart: set-project-id
	@echo "ğŸ”„ Recreating containers to apply changes..."
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- \
		"cd /home/ubuntu/otel-memory && sudo docker-compose up -d --force-recreate"
	@echo "âœ… All services are up-to-date and running!"

# --- è² è·è©¦é¨“ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
GET_COLLECTOR_IP = gcloud compute instances describe $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) --format='get(networkInterfaces[0].networkIP)'

loadgen-ssh: set-project-id
	gcloud compute ssh otel-loadgen --project $(PROJECT_ID) --zone $(ZONE)

# è² è·è©¦é¨“ã®å®Ÿè¡Œ
# ä¾‹: make loadgen SCENARIO=spike DURATION=180s
SCENARIO ?= sustained
DURATION ?= 60s
loadgen: set-project-id
	@IP=$$($(GET_COLLECTOR_IP)); \
	gcloud compute ssh otel-loadgen --project $(PROJECT_ID) --zone $(ZONE) -- \
		"cd /home/ubuntu/otel-memory/loadgen && ./loadgen -endpoint $$IP:4317 -scenario $(SCENARIO) -duration $(DURATION)"

# --- ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ (Distributed) ---

# ã‚·ãƒŠãƒªã‚ª1: ä¸‹æµåœæ­¢ (Jaegeråœæ­¢ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªè“„ç©ã®è¦³æ¸¬)
scenario-1: set-project-id
	@echo "=== Scenario 1: Downstream Failure (Jaeger Stop) ==="
	@IP=$$($(GET_COLLECTOR_IP)); \
	echo "1. Applying scenario-1 config to Collector VM (IP: $$IP)..."; \
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- \
		"sudo chown -R ubuntu:ubuntu /home/ubuntu/otel-memory && \
		 sudo cp /home/ubuntu/otel-memory/otel-collector/scenarios/scenario-1.yaml /home/ubuntu/otel-memory/otel-collector/otel-collector.yaml && \
		 cd /home/ubuntu/otel-memory && sudo docker-compose up -d --force-recreate otel-collector"; \
	echo "2. Starting load from Loadgen VM..."; \
	gcloud compute ssh otel-loadgen --project $(PROJECT_ID) --zone $(ZONE) -- \
		"cd /home/ubuntu/otel-memory/loadgen && ./loadgen -endpoint $$IP:4317 -scenario sustained -duration 180s -rate 12000" & \
	LOADGEN_PID=$$!; \
	echo "â³ Waiting 30s before stopping Jaeger..."; sleep 30; \
	\
	echo "3. ğŸ›‘ Stopping Jaeger on Collector VM..."; \
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- "sudo docker-compose -f /home/ubuntu/otel-memory/docker-compose.yaml stop jaeger"; \
	\
	echo "â³ Observing for 60s..."; sleep 60; \
	\
	echo "4. ğŸ”„ Starting Jaeger on Collector VM..."; \
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- "sudo docker-compose -f /home/ubuntu/otel-memory/docker-compose.yaml start jaeger"; \
	\
	echo "5. Restoring Collector config..."; \
	gcloud compute ssh $(INSTANCE_NAME) --project $(PROJECT_ID) --zone $(ZONE) -- \
		"sudo chown -R ubuntu:ubuntu /home/ubuntu/otel-memory && \
		 git -C /home/ubuntu/otel-memory restore otel-collector/otel-collector.yaml && \
		 cd /home/ubuntu/otel-memory && sudo docker-compose up -d --force-recreate otel-collector"; \
	\
	echo "âœ… Scenario-1 completed. Waiting for loadgen to finish..."; \
	wait $$LOADGEN_PID
