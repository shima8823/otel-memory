# è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ: ã‚·ãƒŠãƒªã‚ª3b - ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«processorï¼ˆé«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£çˆ†ç™ºï¼‰

## 1. æ¦‚è¦

`groupbyattrs` processor ã«é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£å±æ€§ï¼ˆUUIDç­‰ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯å€¤ï¼‰ã‚’æ¸¡ã—ãŸéš›ã® OTel Collector ã®æŒ™å‹•ã‚’æ¤œè¨¼ã€‚ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«processorã®å†…éƒ¨ãƒãƒƒãƒ—ãŒç„¡é™ã«è†¨å¼µã—ã€GCè² è·ã®å¢—å¤§ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã®æ®µéšçš„ä½ä¸‹ã‚’çµŒã¦ã€æœ€çµ‚çš„ã« Collector ãŒ OOM Kill ã•ã‚Œã‚‹éç¨‹ã‚’è¨˜éŒ²ã—ãŸã€‚

**é‡è¦**: ã“ã®ã‚·ãƒŠãƒªã‚ªã¯å®Ÿå‹™ã§æœ€ã‚‚è¦‹è½ã¨ã•ã‚Œã‚„ã™ãã€ã‹ã¤å½±éŸ¿ãŒå¤§ãã„ã€‚é–‹ç™ºç’°å¢ƒã§ã¯å•é¡Œãªãå‹•ä½œã—ã¦ã‚‚ã€æœ¬ç•ªæŠ•å…¥å¾Œã«çªç„¶ãƒ¡ãƒ¢ãƒªçˆ†ç™ºãŒç™ºç”Ÿã™ã‚‹å…¸å‹çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹ã€‚

---

## 2. å†ç¾æ¡ä»¶

### Collector è¨­å®š
- **processor**: `groupbyattrs` (keys: ["attr_0", "attr_1", "attr_2"])
- **memory_limiter**: `limit_percentage: 80` (512MB Ã— 0.8 = 410MB)
- **sending_queue**: `queue_size: 500`
- **batch**: `send_batch_size: 2000`

### è² è·è¨­å®šï¼ˆloadgenï¼‰
- **ã‚·ãƒŠãƒªã‚ª**: sustained
- **ç›®æ¨™ãƒ¬ãƒ¼ãƒˆ**: 8,000 spans/sec
- **å®Ÿè¡Œæ™‚é–“**: 5åˆ†é–“ (300ç§’)
- **é‡è¦**: `-high-cardinality` ãƒ•ãƒ©ã‚° **æœ‰åŠ¹**
  - `attr_0`, `attr_1`, `attr_2` ã« **UUID** ã‚’ä»˜ä¸
  - æ¯å›ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå€¤ â†’ å†…éƒ¨ãƒãƒƒãƒ—ãŒç„¡é™ã«è†¨å¼µ

### ç’°å¢ƒ
- **Collector ãƒ¡ãƒ¢ãƒªåˆ¶é™**: 512MB (Docker Compose)
- **Jaeger ãƒ¡ãƒ¢ãƒªåˆ¶é™**: ãªã—

---

## 3. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

| çµŒéæ™‚é–“ | æ™‚åˆ» | ã‚¤ãƒ™ãƒ³ãƒˆ | ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ | å‚™è€ƒ |
|---------|------|----------|-------------|------|
| **0ç§’** | 17:47:15 | ğŸš€ **è² è·é–‹å§‹** | - | target: 8,000 spans/sec |
| 5ç§’ | 17:47:20 | æ­£å¸¸å‹•ä½œä¸­ | 5,460/sec | åˆæœŸç«‹ã¡ä¸ŠãŒã‚Š |
| 30ç§’ | 17:47:45 | æ­£å¸¸å‹•ä½œä¸­ | 5,657/sec | å®‰å®šç¨¼åƒ |
| **60ç§’** | 17:48:15 | âš ï¸ **memory_limiter ç™ºç«** | 5,513/sec | "data refused due to high memory usage" |
| 105ç§’ | 17:49:00 | ğŸ”» **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆä½ä¸‹é–‹å§‹** | 4,401/sec (â†“21%) | GCè² è·å¢—å¤§ |
| 165ç§’ | 17:50:10 | ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆç¶™ç¶šä½ä¸‹ | 4,252/sec (â†“28%) | Collector ãŒè‹¦ã—ã¿å§‹ã‚ã‚‹ |
| **280ç§’** | 17:52:05 | ğŸ”´ **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆæ¿€æ¸›** | 2,876/sec (â†“49%) | Collector ç€•æ­» |
| **295ç§’** | 17:52:10 | ğŸ’¥ **Collector å®Ÿè³ªåœæ­¢** | 150/sec (â†“97%) | ã»ã¼å¿œç­”ãªã— |
| **301ç§’** | 17:52:16 | âš« **loadgen çµ‚äº†** | - | Collector ã¯æ—¢ã«è½ã¡ã¦ã„ã‚‹ |

### å®šé‡ãƒ‡ãƒ¼ã‚¿

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å€¤ | å‚™è€ƒ |
|-----------|-----|------|
| **ç·é€ä¿¡ã‚¹ãƒ‘ãƒ³æ•°** | 1,430,428 | 5åˆ†é–“ |
| **å¹³å‡ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ** | 4,768 spans/sec | target 8,000 ã® **59.6%** |
| **memory_limiter åˆå›ç™ºç«** | 60ç§’å¾Œ | äºˆæƒ³ã‚ˆã‚Šæ—©ã„ |
| **Collector çŠ¶æ…‹** | OOM Kill | 512MBåˆ¶é™ã«åˆ°é” |
| **Jaeger ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡** | **6.07 GB** / 7.68 GB | 79.07% (ãƒ¡ãƒ¢ãƒªåˆ¶é™ãªã—) |

---

## 4. è¦³æ¸¬ã•ã‚ŒãŸã‚·ã‚°ãƒãƒãƒ£ï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰

### 4.1 ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã®æ®µéšçš„ä½ä¸‹ï¼ˆæœ€é‡è¦ã‚·ã‚°ãƒãƒãƒ£ï¼‰

```
Phase 1 (0-60ç§’):     5,500-5,700 spans/sec âœ… æ­£å¸¸
Phase 2 (60-105ç§’):   4,400-5,600 spans/sec âš ï¸ ä½ä¸‹é–‹å§‹ï¼ˆmemory_limiterç™ºç«ï¼‰
Phase 3 (105-280ç§’):  4,000-5,000 spans/sec âš ï¸ ç¶™ç¶šä½ä¸‹ï¼ˆGCè² è·å¢—å¤§ï¼‰
Phase 4 (280-295ç§’):  150-2,800 spans/sec   ğŸ’¥ å´©å£Šï¼ˆOOMé–“è¿‘ï¼‰
```

**è¨ºæ–­ãƒã‚¤ãƒ³ãƒˆ**: ä¸‹æµãŒæ­£å¸¸ãªã®ã«ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒæ®µéšçš„ã«ä½ä¸‹ã™ã‚‹å ´åˆã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«processorã®ãƒ¡ãƒ¢ãƒªè†¨å¼µã‚’ç–‘ã†ã€‚

### 4.2 ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | æŒ™å‹• | æ„å‘³ |
|-----------|------|------|
| `otelcol_process_runtime_heap_alloc_bytes` | **å³è‚©ä¸ŠãŒã‚Š** â†’ OOM | `groupbyattrs` ã®å†…éƒ¨ãƒãƒƒãƒ—ãŒç„¡é™ã«è†¨å¼µã€‚GCå¾Œã‚‚æˆ»ã‚‰ãªã„ã€‚ |
| `otelcol_receiver_accepted_spans_total` | **æ®µéšçš„ã«æ¸›å°‘** | GCè² è·å¢—å¤§ã«ã‚ˆã‚Šã€å‡¦ç†èƒ½åŠ›ãŒä½ä¸‹ã€‚ |
| `otelcol_receiver_refused_spans_total` | **60ç§’å¾Œã‹ã‚‰å¢—åŠ ** | memory_limiter ãŒç™ºç«ã—ã€ãƒ‡ãƒ¼ã‚¿æ‹’å¦é–‹å§‹ã€‚ |
| `otelcol_exporter_queue_size` / `queue_capacity` | **å¤‰å‹•** | ãƒ¡ãƒ¢ãƒªä¸è¶³ã«ã‚ˆã‚Šã€Queue ã®æŒ™å‹•ã‚‚ä¸å®‰å®šã€‚ |
| **loadgen ã®ã‚¨ãƒ©ãƒ¼** | "context deadline exceeded" | Collector ã®å¿œç­”ãŒé…å»¶ãƒ»åœæ­¢ã€‚ |

---

## 5. è©³ç´°åˆ†æ

### 5.1 é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªè†¨å¼µãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

#### groupbyattrs ã®å†…éƒ¨å‹•ä½œ

`groupbyattrs` processor ã¯ã€æŒ‡å®šã•ã‚ŒãŸ keys ã®å€¤ã”ã¨ã«å†…éƒ¨ãƒãƒƒãƒ—ã‚’ä½œæˆã—ã€ã‚¹ãƒ‘ãƒ³ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ã€‚

**æ­£å¸¸ç³»ï¼ˆã‚·ãƒŠãƒªã‚ª3aï¼‰**:
```
keys: ["attr_0", "attr_1", "attr_2"]
å€¤ã®ç¨®é¡: 10ç¨®é¡ç¨‹åº¦ï¼ˆå›ºå®šï¼‰
å†…éƒ¨ãƒãƒƒãƒ—ã®ã‚µã‚¤ã‚º: æœ€å¤§ 10 ã‚¨ãƒ³ãƒˆãƒª â†’ ãƒ¡ãƒ¢ãƒªå®‰å®š
```

**ç•°å¸¸ç³»ï¼ˆã‚·ãƒŠãƒªã‚ª3bï¼‰**:
```
keys: ["attr_0", "attr_1", "attr_2"]
å€¤ã®ç¨®é¡: UUIDï¼ˆç„¡é™ï¼‰
å†…éƒ¨ãƒãƒƒãƒ—ã®ã‚µã‚¤ã‚º: ç„¡é™ã«å¢—åŠ  â†’ ãƒ¡ãƒ¢ãƒªçˆ†ç™º
```

#### ãƒ¡ãƒ¢ãƒªè†¨å¼µã®æ§˜å­

```
0ç§’:   ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: 0 ã‚¨ãƒ³ãƒˆãƒª,      Heap: 50MB
30ç§’:  ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: 10,000 ã‚¨ãƒ³ãƒˆãƒª,  Heap: 150MB
60ç§’:  ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: 20,000 ã‚¨ãƒ³ãƒˆãƒª,  Heap: 300MB  â† memory_limiterç™ºç«
120ç§’: ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: 40,000 ã‚¨ãƒ³ãƒˆãƒª,  Heap: 410MB  â† ä¸Šé™åˆ°é”
180ç§’: ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: 60,000 ã‚¨ãƒ³ãƒˆãƒª,  Heap: 410MB  â† GC ãŒè¿½ã„ã¤ã‹ãªã„
280ç§’: ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: 100,000+ ã‚¨ãƒ³ãƒˆãƒª, Heap: 410MB  â† OOMé–“è¿‘
295ç§’: ğŸ’¥ OOM Kill
```

### 5.2 GCè² è·å¢—å¤§ã«ã‚ˆã‚‹ã€Œæ­»ã®ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ«ã€

1. **ãƒãƒƒãƒ—è†¨å¼µ** â†’ Heapãƒ¡ãƒ¢ãƒªå¢—åŠ 
2. **memory_limiterç™ºç«** â†’ Force GC å®Ÿè¡Œ
3. **GCå®Ÿè¡Œ** â†’ ã—ã‹ã—ã€ãƒãƒƒãƒ—ã®ã‚¨ãƒ³ãƒˆãƒªã¯ã€Œç”Ÿãã¦ã„ã‚‹ã€ã®ã§è§£æ”¾ã•ã‚Œãªã„
4. **GCæ™‚é–“å¢—åŠ ** â†’ CPUæ™‚é–“ã®å¤§åŠã‚’GCã«è²»ã‚„ã™
5. **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆä½ä¸‹** â†’ ã—ã‹ã—ã€æ–°ã—ã„UUIDã¯æ­¢ã¾ã‚‰ãªã„
6. **ã•ã‚‰ã«ãƒãƒƒãƒ—è†¨å¼µ** â†’ 1ã«æˆ»ã‚‹ï¼ˆæ‚ªå¾ªç’°ï¼‰
7. **æœ€çµ‚çš„ã« OOM Kill**

### 5.3 ä¸‹æµï¼ˆJaegerï¼‰ã¸ã®å½±éŸ¿

**Jaeger ãƒ¡ãƒ¢ãƒª: 6.07 GB** (79.07%)

Collector ãŒè½ã¡ã‚‹å‰ã«é€ä¿¡ã•ã‚ŒãŸç´„143ä¸‡ã‚¹ãƒ‘ãƒ³ã‚’å—ä¿¡ã€‚å„ã‚¹ãƒ‘ãƒ³ãŒé«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£å±æ€§ã‚’æŒã¤ãŸã‚ã€Jaeger ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè‚¥å¤§åŒ–ã—ãŸã€‚

#### Jaeger ã§ã®å•é¡Œ

- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è‚¥å¤§åŒ–**: `attr_0`, `attr_1`, `attr_2` ãŒã™ã¹ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯ â†’ æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå·¨å¤§
- **ã‚¯ã‚¨ãƒªæ€§èƒ½åŠ£åŒ–**: ãƒˆãƒ¬ãƒ¼ã‚¹æ¤œç´¢æ™‚ã«ãƒ¡ãƒ¢ãƒªã‚¹ã‚­ãƒ£ãƒ³ãŒç™ºç”Ÿ
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åœ§è¿«**: ãƒ‡ã‚£ã‚¹ã‚¯I/Oã‚‚å¢—å¤§ï¼ˆ28.2GB Block I/Oï¼‰

**é‡è¦ãªæ•™è¨“**: é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£å•é¡Œã¯ Collector ã ã‘ã§ãªãã€ä¸‹æµã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã‚‚æ³¢åŠã™ã‚‹ã€‚

---

## 6. ã‚·ãƒŠãƒªã‚ª3aï¼ˆæ­£å¸¸ç³»ï¼‰ã¨ã®æ¯”è¼ƒ

| é …ç›® | 3aï¼ˆæ­£å¸¸ç³»ï¼‰ | 3bï¼ˆç•°å¸¸ç³»ï¼‰ | å·®åˆ† |
|------|-------------|-------------|------|
| **loadgen ãƒ•ãƒ©ã‚°** | ãªã— | `-high-cardinality` | **å”¯ä¸€ã®é•ã„** |
| **ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£** | ä½ï¼ˆ10ç¨®é¡ï¼‰ | é«˜ï¼ˆUUIDç„¡é™ï¼‰ | - |
| **memory_limiterç™ºç«** | ãªã— or é…ã„ | **60ç§’** | - |
| **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ** | å®‰å®š | **æ®µéšçš„ä½ä¸‹** | â†“ 41% |
| **Heap Memory** | ä¸€å®šãƒ¬ãƒ™ãƒ«ã§å®‰å®š | **å³è‚©ä¸ŠãŒã‚Š â†’ OOM** | - |
| **GCå¾Œã®æŒ™å‹•** | æ­£å¸¸ã«è§£æ”¾ | **æˆ»ã‚‰ãªã„** | é‡è¦ãªè¨ºæ–­ãƒã‚¤ãƒ³ãƒˆ |
| **CollectorçŠ¶æ…‹** | æ­£å¸¸ç¨¼åƒ | **OOM Kill** | - |
| **Jaeger ãƒ¡ãƒ¢ãƒª** | æ•°ç™¾MBï¼ˆæ¨å®šï¼‰ | **6.07 GB** | - |

**è¨ºæ–­ã®æ±ºã‚æ‰‹**: GCå®Ÿè¡Œå¾Œã‚‚HeapãŒé«˜æ­¢ã¾ã‚Šã—ã€æ™‚é–“ã¨ã¨ã‚‚ã«å³è‚©ä¸ŠãŒã‚Šã«å¢—åŠ ã™ã‚‹å ´åˆã€é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã«ã‚ˆã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«è“„ç©ã‚’ç–‘ã†ã€‚

---

## 7. å®Ÿå‹™ã§ã®ç™ºç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³

### å…¸å‹çš„ãªã‚·ãƒŠãƒªã‚ª

#### ãƒ‘ã‚¿ãƒ¼ãƒ³A: é–‹ç™ºç’°å¢ƒã§ã¯å•é¡Œãªã—ã€æœ¬ç•ªã§çˆ†ç™º

```
é–‹ç™ºç’°å¢ƒ:
- åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆuser_id: 1, 2, 3ï¼‰ãŒç¹°ã‚Šè¿”ã—ã‚¢ã‚¯ã‚»ã‚¹
- groupbyattrs ã® keys: ["user.id"]
- ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: 3ã‚¨ãƒ³ãƒˆãƒª â†’ å•é¡Œãªã— âœ…

æœ¬ç•ªç’°å¢ƒï¼ˆæ–°æ©Ÿèƒ½ãƒªãƒªãƒ¼ã‚¹å¾Œï¼‰:
- ãƒ­ã‚°ã« request_id ã‚’è¿½åŠ ï¼ˆUUIDï¼‰
- groupbyattrs ã® keys: ["user.id", "request.id"]
- ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: ç„¡é™ â†’ OOM Kill ğŸ’¥
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³B: ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å¢—åŠ ã§çªç„¶ç™ºç”Ÿ

```
ä½ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚ï¼ˆ100 req/secï¼‰:
- ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: 1,000ã‚¨ãƒ³ãƒˆãƒª/åˆ†
- GCãŒè¿½ã„ã¤ã â†’ å•é¡Œãªã— âœ…

é«˜ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚ï¼ˆ1,000 req/secï¼‰:
- ãƒãƒƒãƒ—ã‚µã‚¤ã‚º: 10,000ã‚¨ãƒ³ãƒˆãƒª/åˆ†
- GCãŒè¿½ã„ã¤ã‹ãªã„ â†’ OOM Kill ğŸ’¥
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³C: æ„å›³ã—ãªã„é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£å±æ€§

```
å•é¡Œã®ã‚ã‚‹å±æ€§ã®ä¾‹:
- UUID, GUID
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆãƒŸãƒªç§’ç²¾åº¦ï¼‰
- ãƒãƒƒã‚·ãƒ¥å€¤
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆID
- ãƒˆãƒ¬ãƒ¼ã‚¹IDï¼ˆã“ã‚Œã‚’ keys ã«å…¥ã‚Œã‚‹ã¨ç¢ºå®Ÿã«OOMï¼‰
```

---

## 8. å¯¾å‡¦æ³•

### 8.1 è¨­è¨ˆæ®µéšã§ã®å¯¾å‡¦ï¼ˆæœ€é‡è¦ï¼‰

#### âœ… ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚­ãƒ¼ã®é¸å®š

```yaml
# âŒ æ‚ªã„ä¾‹: é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£å±æ€§ã‚’å«ã‚€
groupbyattrs:
  keys: ["user.id", "request.id", "session.id"]  # request.id ãŒUUID

# âœ… è‰¯ã„ä¾‹: ä½ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£å±æ€§ã®ã¿
groupbyattrs:
  keys: ["service.name", "http.method", "http.status_code"]
```

#### âœ… æœ¬ç•ªæŠ•å…¥å‰ã®ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ç¢ºèª

```bash
# Prometheus ã§å±æ€§å€¤ã®ç¨®é¡æ•°ã‚’ç¢ºèª
SELECT count(DISTINCT attr_0) FROM spans WHERE timestamp > now() - 1h;

# 1æ™‚é–“ã§ 1,000 ä»¥ä¸Šãªã‚‰è¦æ³¨æ„
# 10,000 ä»¥ä¸Šãªã‚‰å±é™º
# 100,000 ä»¥ä¸Šãªã‚‰ç¢ºå®Ÿã«OOM
```

### 8.2 é‹ç”¨æ®µéšã§ã®å¯¾å‡¦

#### âœ… memory_limiter ã‚’ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«processorã® **å‰** ã«é…ç½®

```yaml
processors:
  memory_limiter:        # â† å¿…ãšå…ˆé ­
    limit_percentage: 80
  groupbyattrs:          # â† ãã®å¾Œ
    keys: [...]
  batch:
```

#### âœ… ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«ã‚ˆã‚‹æ—©æœŸæ¤œçŸ¥

```prometheus
# HeapãŒå³è‚©ä¸ŠãŒã‚Šã§ã‚¢ãƒ©ãƒ¼ãƒˆ
rate(otelcol_process_runtime_heap_alloc_bytes[5m]) > 0

# GCå¾Œã‚‚ãƒ¡ãƒ¢ãƒªãŒæˆ»ã‚‰ãªã„å ´åˆ
(otelcol_process_runtime_heap_alloc_bytes 
  - otelcol_process_runtime_heap_alloc_bytes offset 1m) > 10MB
```

#### âœ… ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆç›£è¦–

```prometheus
# ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒæ®µéšçš„ã«ä½ä¸‹ã—ãŸã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆ
rate(otelcol_receiver_accepted_spans_total[1m]) 
  < 
rate(otelcol_receiver_accepted_spans_total[5m] offset 5m) * 0.8
```

### 8.3 ç·Šæ€¥æ™‚ã®å¯¾å‡¦

1. **å³åº§ã« Collector ã‚’å†èµ·å‹•** â†’ ãƒãƒƒãƒ—ãŒã‚¯ãƒªã‚¢ã•ã‚Œã€ä¸€æ™‚çš„ã«å›å¾©
2. **é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£å±æ€§ã‚’å‰Šé™¤** â†’ `attributes` processor ã§å‰Šé™¤
3. **groupbyattrs ã‚’ç„¡åŠ¹åŒ–** â†’ è¨­å®šã‹ã‚‰å‰Šé™¤ã—ã¦å†èµ·å‹•
4. **ä¸Šæµã§ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°** â†’ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‰ãªã„

---

## 9. çµè«–ã¨æ•™è¨“

### 9.1 é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã¯ã€Œè¦‹ãˆãªã„çˆ†å¼¾ã€

- é–‹ç™ºç’°å¢ƒã§ã¯å•é¡Œãªãã¦ã‚‚ã€æœ¬ç•ªã§çªç„¶çˆ†ç™ºã™ã‚‹
- åŸå› ã¯ã‚³ãƒ¼ãƒ‰ã§ã¯ãªãã€Œãƒ‡ãƒ¼ã‚¿ã®ç‰¹æ€§ã€ã§ã‚ã‚Šã€ç™ºè¦‹ãŒé…ã‚Œã‚„ã™ã„
- ä¸‹æµã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã‚‚å½±éŸ¿ãŒæ³¢åŠã™ã‚‹ï¼ˆæœ¬ã‚·ãƒŠãƒªã‚ªã§ã¯ Jaeger ãŒ 6GBï¼‰

### 9.2 ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«processorã¯ã€Œè«¸åˆƒã®å‰£ã€

- `groupbyattrs`, `groupbytrace`, `tail_sampling` ãªã©ã¯å¼·åŠ›ã ãŒã€ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã«æ•æ„Ÿ
- è¨­å®šå‰ã«ã€keys ã«æŒ‡å®šã™ã‚‹å±æ€§ã®ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã‚’ **å¿…ãšç¢ºèª** ã™ã‚‹
- ã€Œä½ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã€= 1æ™‚é–“ã§1,000ç¨®é¡ä»¥ä¸‹ãŒç›®å®‰

### 9.3 è¨ºæ–­ã®ãƒã‚¤ãƒ³ãƒˆ

| ç—‡çŠ¶ | åŸå›  |
|------|------|
| Queue 100% å¼µã‚Šä»˜ã | ã‚·ãƒŠãƒªã‚ª1ï¼ˆä¸‹æµåœæ­¢ï¼‰ |
| Queue é«˜ä½ã§ä¹±é«˜ä¸‹ | ã‚·ãƒŠãƒªã‚ª2ï¼ˆã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ä¸è¶³ï¼‰ |
| **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆæ®µéšçš„ä½ä¸‹** + **Heapå³è‚©ä¸ŠãŒã‚Š** | **ã‚·ãƒŠãƒªã‚ª3bï¼ˆé«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ï¼‰** â† æœ¬ã‚·ãƒŠãƒªã‚ª |

### 9.4 æœ¬ç•ªæŠ•å…¥ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

å®Ÿå‹™ã§ `groupbyattrs` ã‚„ `tail_sampling` ã‚’å°å…¥ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ï¼š

- [ ] keys ã«æŒ‡å®šã™ã‚‹å±æ€§ã®ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã‚’ç¢ºèªã—ãŸï¼ˆ1æ™‚é–“ã§1,000ç¨®é¡ä»¥ä¸‹ï¼‰
- [ ] memory_limiter ã‚’ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«processorã®å‰ã«é…ç½®ã—ãŸ
- [ ] Heapãƒ¡ãƒ¢ãƒªã®ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¨­å®šã—ãŸ
- [ ] ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆä½ä¸‹ã®ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¨­å®šã—ãŸ
- [ ] ç·Šæ€¥æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’æº–å‚™ã—ãŸï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
- [ ] æœ¬ç•ªç›¸å½“ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã§è² è·ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ãŸ

---

## 10. å‚è€ƒæƒ…å ±

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [groupbyattrs processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/groupbyattrsprocessor)
- [memory_limiter processor](https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/memorylimiterprocessor/README.md)
- [scenario.md](../scenario.md) - ã‚·ãƒŠãƒªã‚ª3b ã®å†ç¾æ‰‹é †

### å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
```bash
make scenario-3b  # é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã‚·ãƒŠãƒªã‚ª
make scenario-3a  # æ­£å¸¸ç³»ï¼ˆæ¯”è¼ƒç”¨ï¼‰
```
