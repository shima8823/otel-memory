# Copyright The OpenTelemetry Authors
# SPDX-License-Identifier: Apache-2.0

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
processors:
  memory_limiter:
    check_interval: 1s
    limit_mib: 256      # hard-limitをあえて低めにして発火させやすくする
    spike_limit_mib: 64

  # batch: メモリを溜める原因になる（意図的に大きく設定）
  batch:
    send_batch_size: 20000       # 大きなバッチ
    send_batch_max_size: 50000
    timeout: 10s                 # 長いタイムアウト（バッファが溜まりやすい）
extensions:
  health_check: {}
exporters:
  otlp:
    endpoint: jaeger:4317
    tls:
      insecure: true
    # sending_queue: メモリ高騰の原因になるキュー
    sending_queue:
      enabled: true
      num_consumers: 2
      queue_size: 10000   # 大きなキュー（メモリを食う）
  prometheus:
    endpoint: 0.0.0.0:9090
    namespace: testapp
    sending_queue:
      enabled: true
      num_consumers: 2
      queue_size: 10000   # 大きなキュー（メモリを食う）
  debug:

service:
  telemetry:
    metrics:
      readers:
        - pull:
            exporter:
              prometheus:
                host: '0.0.0.0'
                port: 8888
  extensions: [health_check]
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, batch]  # batch追加
      exporters: [otlp, debug]

    metrics:
      receivers: [otlp]
      processors: [memory_limiter, batch]  # batch追加
      exporters: [prometheus, debug]

    logs:
      receivers: [otlp]
      processors: [memory_limiter, batch]  # batch追加
      exporters: [otlp, debug]